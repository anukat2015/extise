#!/usr/bin/env ruby
require_relative 'common' and load_extise!

e, c, s, t, v, m, a = false, true, true, 80, true, nil, nil

ARGV.bind_and_parse! to: :locals do
  use '[<options>] <model> <attribute>'
  use '[<options>] -e [<command>...]'
  opt 'e -e --eval'
  opt 'c -c --[no-]color'
  opt 's -s --[no-]sort'
  opt 't -t --trim[=<length:Integer>]'
  opt 'v -v --[no-]verbose'
  arg 'm <model>'
  arg 'a <attribute>'
end

AutoColor.disable on: self unless c

data = Class.const_get(m).pluck(a) rescue abort("Unable to #{m}.pluck #{a}".red) unless e
args = %w(color sort verbose).map { |o| options.bound[o[0].to_sym] ? "-#{o[0]}" : "--no-#{o}" }
args.insert -2, "-t#{t}"

if e
  data, args = %w(load_extise!) + ([m, a] + ARGV).compact.map { |x| Shellwords.escape x }, args << '-e'
  args, data = args + ["'#{data[0]};[]'"] + data[1..-1], [] if data.size > 1
end

Open3.popen3(File.expand_path "hist #{args * ' '}", __dir__) do |input, output, error, status|
  Thread.new { output.each { |l| print l }}
  Thread.new { error.each { |l| STDERR.print l }}

  unless data.empty?
    input.print data * "\n"
    STDIN.each { |l| input.print "\n#{l}" } if e
  end

  input.close
  abort unless status.value.to_i.zero?
end
