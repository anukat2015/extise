#!/usr/bin/env ruby
require_relative 'common' and load_extise!

n, w = 4, :thread
c, s, t, v, q, r = true, false, 80, true, false, nil

ARGV.bind_and_parse! to: :locals do
  use '[<options>] <project>'
  opt 'n    --parallel[=<count:Integer>]'
  opt 'w    --parallel-worker=(process|thread)'
  opt 'c -c --[no-]color'
  opt 's -s --[no-]sort'
  opt 't -t --trim[=<length:Integer>]'
  opt 'v -v --[no-]verbose'
  opt 'q -q --quiet'
  arg 'r <repository>'
end

n = 0 unless options.assigned? :n
v, q = false, true unless n.zero?

AutoColor.disable on: self unless c

include Extisimo

# NOTE: interaction file path is relative to Eclipse project whereas element file path is relative
# to Git repository root, interaction file path relative root can not be recomputed to Git repository
# root since the interaction may refer to an uncommitted file

# NOTE: to connect interactions with elements not only file paths must be matched but node paths must
# be matched also, hence node paths should include method parameters in comparable format and should
# also cover all possible nested nodes

# NOTE: ignore constant declarations and all possibly nested elements
# NOTE: ignore type and method declarations nested in anonymous classes
# NOTE: infer node path from file when missing
# NOTE: strip method parameters

def parse_structure_handle(h)
  d, p, n, e = *h[1..-1].split(/&lt;|\{|\[/)
  return unless n
  f = File.join d, p.split(/\./), n
  e = e ? File.join(e.sub(/\^.*\z/, '').sub(/~[^;]+;.*\z/, '').split(/~/)) : File.basename(f, '.java')
  { directory: d, package: p, name: n, file: f, element: e }
end

repository = Repository.find_by name: r

abort "#{Repository}:? not found by #{r}".red unless repository

dump_record repository, :repository

# NOTE: command, preference, and attention kinds are completely missing from original data
# NOTE: navigation does not hold any information value in original data and can be ignored
# NOTE: interaction delta in original data is always blank and therefore can be ignored
# NOTE: select only interactions with non empty structure handle

interactions = BugsEclipseOrg::Interaction.joins(attachment: [extisimo_attachment: [task: [project: :repositories]]]).where(
  Repository.table_name => { id: repository },
  kind: %w(command edit selection),
  structure_kind: %w(java),
  originid: %w(
    org.eclipse.jdt.ui.ClassFileEditor
    org.eclipse.jdt.ui.CompilationUnitEditor
    org.eclipse.jdt.ui.PackageExplorer
  )
).where.not(structure_handle: nil).order(start_date: :asc)

previous_session = nil

process interactions, count: n, worker: w, progress: !n.zero? do |i|
  attachment = i.attachment.extisimo_attachment
  user = attachment.author
  commits = Extisimo::Commit.where(author: user).where('submitted_at > ?', i.start_date).order(submitted_at: :asc)

  # NOTE: consider consecutive commits A, B, C where A and C have the same author and B is authored by someone else,
  # and a session identified by commit C is created, then C is revision commit, B is original commit, and A is a commit
  # by the same author previous to revision, the session is then bounded by A and C

  previous, revision = *commits.limit(3)

  # NOTE: skip all interactions of initial session, i.e. ignore all unbounded sessions

  next unless previous

  abort "#{BugsEclipseOrg::Interaction}:#{i.id} revision commit not found".red unless revision

  session = persist(Session, user: user, revision_commit: revision) do |r|
    r.previous_commit = previous
    r.previous_identifier = previous.identifier
    r.revision_identifier = revision.identifier
    r.started_at = previous.submitted_at
    r.finished_at = revision.submitted_at
  end

  dump_record previous_session = session, :session, 1 unless previous_session == session

  handle = parse_structure_handle i.structure_handle

  # NOTE: skip interactions with missing data in structure handle

  unless handle
    warn "#{BugsEclipseOrg::Interaction}:#{i.id} missing data in structure handle".magenta
    next
  end

  # NOTE: crop node paths to match top level Java type declarations

  p = handle[:element].sub(/\/.*\z/, '')

  # NOTE: skip possible top level package-private classes (should not affect rename refactorings)

  next if File.basename(handle[:file], '.java') != p

  interaction = persist(Extisimo::Interaction, bugs_eclipse_org_interaction_id: i.id) do |r|
    r.attachment = attachment
    r.session = session
    r.kind = i.kind
    r.file = handle[:file]
    r.path = p
    r.started_at = i.start_date
    r.finished_at = i.end_date
  end

  dump_record interaction, :interaction, 2
end
