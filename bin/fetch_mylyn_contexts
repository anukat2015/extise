#!/usr/bin/env ruby
require_relative 'common'

o, c, v, q, p = nil, true, true, false, [STDIN]

ARGV.bind_and_parse! to: :locals do
  use '[<options>] [<file>...]'
  opt 'o -o --output=<path>'
  opt 'c -c --[no-]color'
  opt 'v -v --[no-]verbose'
  opt 'q -q --quiet'
  arg 'p [<path>...]'
end

AutoColor.enable on: self, colored: c, colorings: {
  /bug \d*/ => :blue,
  /attachment \d*/ => -> (s, r) { s.sub(r) { |p| p.yellow }},
}

i = v && !options.default?(:p) ? 1 : 0
o ||= File.expand_path('../../../data/bugs.eclipse.org/mylyn-context', __FILE__)

FileUtils.mkpath o

p.each do |f|
  d = Nokogiri::XML File.open_or f

  puts "#{f.green}" unless q || i.zero?

  d.css('bug').each do |bug|
    bug_id = bug.css('bug_id').text.strip

    puts "#{'  ' * i}bug #{bug_id}" unless q

    bug.css('attachment').each do |attachment|
      attachment_id = attachment.css('attachid').text.strip
      attachment_filename = attachment.css('filename').text.strip

      puts "#{'  ' * (i + 1)}attachment #{attachment_id} #{attachment_filename}" unless q

      file = File.join o, "#{attachment_id}.xml"

      if attachment_filename == 'mylyn-context.zip' && !File.exist?(file)
        system "curl -#{'s' if !v || q}S https://bugs.eclipse.org/bugs/attachment.cgi?id=#{attachment_id} | tar -xO > #{file}"
      end
    end
  end
end
