#!/usr/bin/env ruby
require_relative 'common'

c, o, p = true, nil, nil

ARGV.bind! to: self do
  use '[<options>] [<file>]'
  opt 'c -c --[no-]color'
  opt 'o -o --output'
  arg 'p [<path>]'
end

AutoColor.enable on: self, colored: c, colorings: {
  /bug \d*/ => :blue,
  /attachment \d*/ => -> (s, r) { s.sub(r) { |p| p.yellow }},
}

o ||= File.expand_path('../../../data/bugs.eclipse.org/mylyn-context', __FILE__)
d = p ? File.open(p) { |f| Nokogiri::XML f } : Nokogiri::XML(STDIN)

FileUtils.mkpath o

d.css('bug').each do |bug|
  bug_id = bug.css('bug_id').text.strip

  puts "bug #{bug_id}"

  bug.css('attachment').each do |attachment|
    attachment_id = attachment.css('attachid').text.strip
    attachment_filename = attachment.css('filename').text.strip

    puts "  attachment #{attachment_id} #{attachment_filename}"

    file = File.join o, "#{attachment_id}.xml"

    if attachment_filename == 'mylyn-context.zip' && !File.exist?(file)
      system "curl -sS https://bugs.eclipse.org/bugs/attachment.cgi?id=#{attachment_id} | tar -xO > #{file}"
    end
  end
end
