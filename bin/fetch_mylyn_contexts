#!/usr/bin/env ruby
require_relative 'common'

o, n, w, p = nil, 4, :thread, [STDIN]
c, v, q = true, true, false

ARGV.bind_and_parse! to: :locals do
  use '[<options>] [<file>...]'
  opt 'o -o --output=<path>'
  opt 'n    --parallel[=<count:Integer>]'
  opt 'w    --parallel-worker=(process|thread)'
  opt 'c -c --[no-]color'
  opt 'v -v --[no-]verbose'
  opt 'q -q --quiet'
  arg 'p [<path>...]'
end

n = 0 unless options.assigned? :n
v, q = false, true unless n.zero?

AutoColor.enable on: self, colored: c, colorings: {
  /bug \d*/ => :blue,
  /attachment \d*/ => -> (s, r) { s.sub(r) { |p| p.yellow }},
}

i = v && !options.default?(:p) ? 1 : 0

FileUtils.mkpath o ||= File.expand_path('../../../data/bugs.eclipse.org/mylyn-context', __FILE__)

p.each do |f|
  d = Nokogiri::XML File.open_or f

  puts "#{f.green}" unless q || i.zero?

  process d.css('bug'), count: n, worker: w, progress: !n.zero? do |bug|
    bug_id = bug.css('bug_id').text.strip

    puts "#{'  ' * i}bug #{bug_id}" unless q

    bug.css('attachment').each do |attachment|
      attachment_id = attachment.css('attachid').text.strip
      attachment_filename = attachment.css('filename').text.strip

      puts "#{'  ' * (i + 1)}attachment #{attachment_id} #{attachment_filename}" unless q

      file = File.join o, "#{attachment_id}.xml"

      if attachment_filename == 'mylyn-context.zip' && !File.exist?(file)
        system "curl -#{'s' if !v || q}S https://bugs.eclipse.org/bugs/attachment.cgi?id=#{attachment_id} | tar -xO > #{file}"
      end
    end
  end
end
